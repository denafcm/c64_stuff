import sys
import array
from copy import copy

#ersion = '1.0 [March, 2008]'
version = '1.1 [October, 2014]'

decr = [0xA0, 0x00, 0x78, 0xE6, 0x01, 0xA2, 0x01, 0xB9, # 00-07
	0xA3, 0x07, 0x99, 0x00, 0xFF, 0xC8, 0xD0, 0xF7, # 08-0F
	0xCE, 0x0A, 0x08, 0xCE, 0x0D, 0x08, 0xCA, 0xD0, # 10-17
	0xEE, 0xA2, 0x69, 0xBD, 0x27, 0x08, 0x9D, 0xFA, # 18-1F
	0x00, 0xCA, 0xD0, 0xF7, 0x4C, 0x09, 0x01, 0xEE, # 20-27
	0xFF, 0x8D, 0x01, 0x08, 0xE6, 0xFE, 0xD0, 0x02, # 28-2F
	0xE6, 0xFF, 0xCA, 0xD0, 0xF4, 0xA0, 0x00, 0xB1, # 30-37
	0xFB, 0xC9, 0xB8, 0xF0, 0x1C, 0xC9, 0xB2, 0xF0, # 38-3F
	0x38, 0xC8, 0xA2, 0x01, 0xE6, 0xFB, 0xD0, 0x02, # 40-47
	0xE6, 0xFC, 0xF0, 0x05, 0x88, 0xD0, 0xF5, 0xF0, # 48-4F
	0xD8, 0xA9, 0x37, 0x85, 0x01, 0x58, 0x4C, 0x17, # 50-57
	0x08, 0xC8, 0xB1, 0xFB, 0xC9, 0x10, 0xF0, 0x11, # 58-5F
	0x48, 0x4A, 0x4A, 0x4A, 0x4A, 0xD0, 0x02, 0xA9, # 60-67
	0x10, 0xAA, 0x68, 0x29, 0x0F, 0xA0, 0x02, 0xD0, # 68-6F
	0xD3, 0xA9, 0xB8, 0xA2, 0x01, 0xA0, 0x02, 0xD0, # 70-77
	0xCB, 0xC8, 0xB1, 0xFB, 0xC9, 0x01, 0xF0, 0x08, # 78-7F
	0xAA, 0xC8, 0xB1, 0xFB, 0xA0, 0x03, 0xD0, 0xBC, # 80-87
	0xA9, 0xB2, 0xA2, 0x01, 0xA0, 0x02, 0xD0, 0xB4] # 88-8F

def makedepacker(params, packlength):
	d = copy(decr)
	for (k, v) in params:
		if k == 'CNTRLBY1': d[0x3A] = d[0x72] = v
		if k == 'CNTRLBY2': d[0x3E] = d[0x89] = v
		if k == 'LOADADDR': d[0x2A] = v&255; d[0x2B] = v>>8
		if k == 'ROMSTAT':  d[0x52] = v
		if k == 'CLI/SEI':  d[0x55] = v
		if k == 'SYSADDR':  d[0x57] = v&255; d[0x58] = v>>8

	d[0x06] = (packlength>>8) + 1

	lastpage = 0x0801 + len(d) + packlength - 256
	d[0x08] = lastpage&255; d[0x09] = lastpage>>8

	lowmem = 0x10000 - packlength
	d[0x27] = lowmem&255; d[0x28] = lowmem>>8

	return array.array('B', d)

if __name__ == '__main__':

	w = open('out', 'wb')
	w.write(makedepacker((
		('CNTRLBY1', 0x75),
		('CNTRLBY2', 0x5b)), 666))
	w.close()

